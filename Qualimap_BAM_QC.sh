#!/bin/bash
#SBATCH --job-name=QC_NPO
#SBATCH --time=1-00:00:00
#SBATCH -N 1
#SBATCH -c 4
#SBATCH --mem=16000
#SBATCH --qos=Std
#SBATCH --output=/lustre/nobackup/WUR/ABGC/verho158/QC/slurm_output_QC_%A_%a.txt
#SBATCH --error=/lustre/nobackup/WUR/ABGC/verho158/QC/slurm_error_QC_%A_%a.txt
#SBATCH --array=1-148  # Adjust to your number of samples

# Load Conda environment
source /home/WUR/verho158/miniconda3/etc/profile.d/conda.sh
conda activate pigeon_env

# Base directories
bam_dir="/lustre/nobackup/WUR/ABGC/verho158/all_bams"
out_dir="/lustre/nobackup/WUR/ABGC/verho158/QC"

# Determine sample name based on SLURM_ARRAY_TASK_ID
sample=$(printf "NPO_%d_dedup.bam" $SLURM_ARRAY_TASK_ID)
bam_file="${bam_dir}/${sample}"

# Check if BAM file exists
if [ ! -f "$bam_file" ]; then
    echo "BAM file not found for ${sample}, skipping..."
    exit 1
fi

# Create output directory for sample
sample_out_dir="${out_dir}/${sample%.bam}"
mkdir -p "$sample_out_dir"

# Resources for Qualimap
threads=4
java_mem_size="16G"

# Run Qualimap BAM QC
echo "Running Qualimap BAM QC for ${sample}..."
unset DISPLAY  # prevent GUI issues on HPC

qualimap bamqc \
    -bam "$bam_file" \
    -outdir "$sample_out_dir" \
    -nt "$threads" \
    --java-mem-size="$java_mem_size"

echo "Qualimap BAM QC completed for ${sample}!"

# Optional: extract per-chromosome coverage & MAPQ summary
# genome_results.txt is generated by Qualimap
genome_results="${sample_out_dir}/genome_results.txt"

if [ -f "$genome_results" ]; then
    echo "Extracting key metrics from genome_results.txt for ${sample}..."
    awk '
        BEGIN {print "Chromosome\tLength(bp)\tCovered(bp)\tMeanCoverage\tStdCoverage"}
        /^>>>>>>> Coverage per contig/ {flag=1; next}
        flag && /^[0-9XYMT]/ {
            print $1 "\t" $2 "\t" $3 "\t" $4 "\t" $5
        }
        flag && /^$/{flag=0}
    ' "$genome_results" > "${sample_out_dir}/${sample%.bam}_perContigCoverage.txt"

    # Mapping quality summary
    awk -F"=" '/mean mapping quality/ {print "Mean mapping quality: "$2}' "$genome_results" > "${sample_out_dir}/${sample%.bam}_MAPQ_summary.txt"
    echo "Extraction done for ${sample}!"
fi

# Deactivate Conda
conda deactivate
echo "QC pipeline finished for ${sample}!"
